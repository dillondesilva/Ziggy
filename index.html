<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Happy Zig</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background: grey;
        }
    </style>
    <link href="https://fonts.googleapis.com/css?family=Anton" rel="stylesheet">
</head>
<body>
<h1 style="float: right; font-family: 'Anton', sans-serif;" id="scoreText">Score: 0</h1>
<div style="text-align:center;">
<script type="text/javascript">
    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update});;
    var scoreText = document.getElementById('scoreText');
    function preload ()
    {
        this.load.image('player', 'assets/sprite.svg');
        this.load.image('background', 'assets/bg_one.svg');
        this.load.image('badguy-A', 'assets/badguy.svg');
        this.load.image('explosion', 'assets/explosion.svg');
        this.load.image('playerbullet', 'assets/bullets.svg');
        this.load.image('enemybullet', 'assets/enemyBullet.svg');
        this.load.image('star', 'assets/star.svg');
    }
    var player;
    var playerBullets;
    var enemyBulletTime = 0;
    var bulletTime = 0;
    var ALIVE = true;
    var enemies;
    var stars;

    var SCORE = 0;

    function create ()
    {
        game.physics.startSystem(Phaser.Physics.ARCADE);
        
        this.add.image(0, 0, 'background');
        player = game.add.sprite(400, 450, 'player');

        player.anchor.setTo(0.5, 0.5);

        enemies = game.add.group();
        stars = game.add.group();
        
        game.physics.enable(player, Phaser.Physics.ARCADE);


        game.time.events.loop(Phaser.Timer.HALF * 5, createEnemy, this);
        game.time.events.loop(Phaser.Timer.HALF * 2, createStar, this);

        // The group of bullets for player one and its setup
        playerBullets = game.add.group();
        playerBullets.enableBody = true;
        playerBullets.physicsBodyType = Phaser.Physics.ARCADE;
        playerBullets.createMultiple(30, 'playerbullet');
        playerBullets.setAll('anchor.x', 0.5);
        playerBullets.setAll('anchor.y', 1);
        playerBullets.setAll('outOfBoundsKill', true);
        playerBullets.setAll('checkWorldBounds', true);

        // Group of bullets for the enemy. Initial group has the pool
        // of bullets set to 30;
        enemyBullets = game.add.group();
        enemyBullets.enableBody = true;
        enemyBullets.physicsBodyType = Phaser.Physics.ARCADE;
        enemyBullets.createMultiple(30, 'enemybullet');
        enemyBullets.setAll('anchor.x', 0.5);
        enemyBullets.setAll('anchor.y', 1);
        enemyBullets.setAll('outOfBoundsKill', true);
        enemyBullets.setAll('checkWorldBounds', true);
    }

    function update ()
    {
        cursors = this.input.keyboard.createCursorKeys();

        if (ALIVE) {
            if (cursors.left.isDown) {
                player.x -= 10;
            } else if (cursors.right.isDown) {
                player.x += 10;
            } 

            if (cursors.up.isDown) {
                fireBullet();
            }
        } else {
            player.angle += 3;
        }

        for (e in enemies.children) {
            console.log(e);
            enemies.children[e].angle += 10;
        }

        for (s in stars.children) {
            console.log(s);
            stars.children[s].angle += 1;
        }
        game.physics.arcade.overlap(player, enemies, playerDeath, null, this);
        game.physics.arcade.overlap(playerBullets, enemies, enemyDeath, null, this);
    }

    function playerDeath() {
        console.log('hit');
        player.loadTexture('explosion', 0);
        ALIVE = false;

        scoreText.innerText = "GAME OVER! Score: " + String(SCORE)
        enemies.destroy();

        setTimeout(function() {
             player.kill();
         }, 3000);
    }

    function createEnemy () {
    // Add our sprite here with a random x co-ordinate
    var enemy = game.add.sprite(Math.floor(Math.random() * 750, 10), -60, 'badguy-A');

    // Activate the physics system and choose an arbitary gravity value
    game.physics.arcade.enable(enemy);

    var gravityLevel = Math.floor(Math.floor(Math.random() * 600, 250));
    enemy.body.gravity.y = gravityLevel;
    enemy.anchor.setTo(0.5, 0.5);
    enemy.checkWorldBounds = true;
    enemy.outOfBoundsKill = true;

    enemies.add(enemy);
    
    // // enemy bullet is fired after one second
    // setTimeout(function() {
    //     fireEnemyBullet(enemy);
    // }, 500);
    }

    function createStar() {
    // Add our sprite here with a random x co-ordinate
    var star = game.add.sprite(Math.floor(Math.random() * 700, 10), -60, 'star');

    // Activate the physics system and set gravity on it to 250
    game.physics.arcade.enable(star);

    star.body.gravity.y = 250;
    star.anchor.setTo(0.5, 0.5);
    star.checkWorldBounds = true;

    stars.add(star);        
    }

    function fireBullet () {
        if (game.time.now > bulletTime) {
            // Retrieving the first bullet from the pool
            var bullet = playerBullets.getFirstExists(false);

            // And Fire!
            if (bullet) {
            bullet.reset(player.x + 7, player.y + 8);
            bullet.body.velocity.y = -600;
            bulletTime = game.time.now +1000;
            }
        }
    }

    function enemyDeath (bullet, enemy) {
        // Deactivate the enemies basic abilities. E.g: Gravity
        enemy.body.moves = false;

        // Create an explosion
        enemy.loadTexture('explosion');

        SCORE += 100;

        scoreText.innerText = "Score: " + String(SCORE);

        // Kill the bullet and enemies
        bullet.kill();

        setTimeout(function() {
             enemy.kill();
         }, 1000);
    }

    // Firing an enemy bullet
    // function fireEnemyBullet (enemy) {
    //     if (game.time.now > enemyBulletTime) {
    //     var bullet = enemyBullets.getFirstExists(false);

    //     if (bullet) {
    //         bullet.reset(enemy.x + 20, enemy.y + 8);
    //         bullet.body.velocity.y = 600;
    //         enemyBulletTime = game.time.now + 200;
    //     }
    //     }
    // }

</script>
</div>

</body>
</html>